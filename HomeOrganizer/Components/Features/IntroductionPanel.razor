@using HomeOrganizer.Common;
@using HomeOrganizer.Components.Common
@using HomeOrganizer.Components.Errors
@using HomeOrganizer.Models.Bases;
@using HomeOrganizer.Models.Communication;
@using HomeOrganizer.Models.Features;
@using HomeOrganizer.Models.User;
@using ApexCharts;

@inject UserService userService
@inject NavigationManager navigationManager
@implements IDisposable

@if (Feature == null || introduction == null)
{
    <NoFeaturePanelError Feature="@Feature" CastToFeature="@introduction" PanelName="Introduction" />
    return;
}

<MudStack>

    <FeatureTopBar Feature="introduction" />

    <MudGrid>

        <MudItem xs="7">
            <MudPaper Height="200px" Class="pa-2">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h5">
                        Hello!
                    </MudText>
                    <MudText Typo="Typo.body1">
                        This is the introduction for Home Organizer,
                        our application that helps keeping everything together.
                    </MudText>
                    <MudText Typo="Typo.body1">
                        This panel is a playground for you to test
                        some smaller features that are used in other panels.
                    </MudText>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="1">
            <MudPaper Height="200px" Class="mud-theme-transparent" Elevation="0" />
        </MudItem>

        <MudItem xs="4">
            <MudPaper Height="200px" Style="overflow:hidden;" Elevation="0" Class="mud-theme-transparent" Square="true">
                <MudImage Src="images/introduction/dog.jpg"
                          Class="rounded"
                          ObjectFit="ObjectFit.ScaleDown"
                          Height="200" />
            </MudPaper>
        </MudItem>

        <MudItem xs="4">
            <MudPaper Height="200px" Style="overflow:hidden;">
                <MudImage Src="images/introduction/sunset.jpg"
                          ObjectFit="ObjectFit.Cover"
                          Style="width:100%;" Height="200" />
            </MudPaper>
        </MudItem>

        <MudItem xs="1">
            <MudPaper Height="200px" Class="mud-theme-transparent" Elevation="0" />
        </MudItem>

        <MudItem xs="7">
            <MudPaper Height="200px" Class="pa-2">
                <MudText Typo="Typo.body1">
                    You can edit this panel data from previous screen - home page.
                    Click <i>tile settings icon</i> (right top) and change something!
                </MudText>
                <MudText Typo="Typo.body1">
                    You can add more panels in home screen by clicking bottom + button and chosing one!
                    Every panel is different in its structure and offers different features.
                    If you cannot find the right panel for your requirements you can create custom one.
                    Or maybe you have some thoughts on existing ones? Let us know via contact form - bottm right button.
                </MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="6">
            <MudPaper Height="300px" Class="pa-2 overflow-scroll">
                <ApexChart TItem="SinglePoint" Height="260" Width="1500" Options="@options" @ref="@chart"
                           Title="Your expanses">

                    @foreach (var series in DataSeries)
                    {
                        <ApexPointSeries TItem="SinglePoint"
                                     Items="@series.Value"
                                     Name="@series.Key"
                                     SeriesType="SeriesType.Bar"
                                     XValue="e => e.CreateDateText()"
                                     YValue="e=> (decimal)e.Value" />
                    }

                </ApexChart>
            </MudPaper>
        </MudItem>

        <MudItem xs="6">
            <MudPaper Height="300px" Class="overflow-hidden">
                <MudCarousel Class="mud-width-full" Style="height:300px;" ShowArrows="true" ShowBullets="false" EnableSwipeGesture="true" AutoCycle="true" TData="object">
                    <MudCarouselItem Transition="Transition.Slide" Color="@MudBlazor.Color.Secondary">
                        <div class="d-flex" style="height:100%">
                            <MudImage Src="images/introduction/szczyrk.jpg"
                                      ObjectFit="ObjectFit.Cover"
                                      Style="width:100%;" Height="300" />
                        </div>
                    </MudCarouselItem>
                    <MudCarouselItem Transition="Transition.Slide" Color="@MudBlazor.Color.Secondary">
                        <div class="d-flex" style="height:100%">
                            <MudImage Src="images/introduction/skrzyczne.jpg"
                                      ObjectFit="ObjectFit.Cover"
                                      Style="width:100%;" Height="300" />
                        </div>
                    </MudCarouselItem>
                    <MudCarouselItem Transition="Transition.Slide" Color="@MudBlazor.Color.Secondary">
                        <div class="d-flex" style="height:100%">
                            <MudImage Src="images/introduction/ojcow.jpg"
                                      ObjectFit="ObjectFit.Cover"
                                      Style="width:100%;" Height="300" />
                        </div>
                    </MudCarouselItem>
                </MudCarousel>
            </MudPaper>
        </MudItem>

        <MudItem xs="3">
            <MudPaper Height="500px" Class="pa-2">
                <MudStack Style="height:100%;">

                    <MudText Typo="Typo.body1">
                        Grocery list
                    </MudText>

                    @if (groceryList.Count > 0)
                    {

                        <MudPaper MaxHeight="450px" Class="mud-theme-transparent overflow-scroll" Elevation="0">

                            <MudList Clickable="true" Dense="true" DisableGutters="false" SelectedValue="@selectedValue" SelectedValueChanged="CrossGroceryItem">
                                @foreach (var groceryItem in groceryList)
                                {
                                    string icon = groceryItem.Value ? Icons.Material.Filled.Bookmark : Icons.Material.Filled.BookmarkBorder;
                                    string textStyle = groceryItem.Value ? "text-decoration: line-through;" : string.Empty;

                                    <MudListItem Value="@groceryItem.Key" Icon="@icon" IconColor="MudBlazor.Color.Secondary">
                                        <MudText Typo="Typo.body1" Style="@textStyle">
                                            @groceryItem.Key
                                        </MudText>
                                    </MudListItem>
                                }
                            </MudList>
                        </MudPaper>

                    }

                    <MudSpacer />

                    <MudPaper Height="80px" Class="mud-theme-transparent" Elevation="0">

                        <MudTextField @bind-Value="newGroceryItem"
                                      For="@(() => newGroceryItem)"
                                      @ref="addGroceryItemField"
                                      Immediate="true"
                                      Placeholder="New item to buy"
                                      Error="@(addGroceryItemError.Length > 0)"
                                      ErrorText="@addGroceryItemError"
                                      Label="New item" Variant="Variant.Text"
                                      InputType="@InputType.Text" Adornment="Adornment.End"
                                      AdornmentIcon="@Icons.Material.Filled.Add" OnAdornmentClick="AddGroceryItem"
                                      AdornmentAriaLabel="Add item"
                                      OnKeyDown="AddGroceryItemEnter"
                                      OnKeyUp="AddGroceryItemEnter" />
                    </MudPaper>
                </MudStack>

            </MudPaper>
        </MudItem>

        <MudItem xs="6">
            <MudPaper Height="500px" Class="px-2 mud-theme-transparent" Elevation="0">
                <MudStack Justify="Justify.SpaceBetween" Style="height:100%;">
                    <MudPaper Height="240px" Class="pa-2">
                        <MudText Typo="Typo.body1">
                            Multiple panels fun
                        </MudText>
                    </MudPaper>
                    <MudPaper Height="240px" Class="pa-2 ">
                        <MudText Typo="Typo.body1">
                            Multiple panels fun
                        </MudText>
                    </MudPaper>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="6">

        </MudItem>

    </MudGrid>

</MudStack>


@code {
    [Parameter]
    public FeatureBase? Feature { get; set; }
    private Introduction? introduction = null;

    #region Grocery List
    MudTextField<string> addGroceryItemField;
    private string newGroceryItem = string.Empty;
    private string addGroceryItemError = string.Empty;
    private Dictionary<string, bool> groceryList = new Dictionary<string, bool>();
    private string selectedValue = string.Empty;
    private async Task AddGroceryItemEnter(KeyboardEventArgs args)
    {
        if (args.Code == "Enter" && addGroceryItemField != null)
        {
            await AddGroceryItem();
            return;
        }

        if (!groceryList.ContainsKey(newGroceryItem))
            addGroceryItemError = string.Empty;
        else
            addGroceryItemError = $"{newGroceryItem} already exists!";
    }
    private async Task AddGroceryItem()
    {
        if (groceryList.ContainsKey(newGroceryItem))
        {
            addGroceryItemError = $"{newGroceryItem} already exists!";
            return;
        }
        if (newGroceryItem.Length == 0)
            return;


        addGroceryItemField.TextUpdateSuppression = false;

        groceryList.Add(newGroceryItem, false);

        newGroceryItem = string.Empty;
        await InvokeAsync(StateHasChanged);
        await Task.Run(async () =>
        {
            await Task.Delay(150);
            addGroceryItemField.TextUpdateSuppression = true;
        });
    }

    private void CrossGroceryItem(object selectedGroceryItem)
    {
        if (selectedGroceryItem is not string groceryItem) return;
        if (!groceryList.ContainsKey(groceryItem)) return;

        groceryList[groceryItem] = !groceryList[groceryItem];
        selectedValue = string.Empty;
        StateHasChanged();
    }
    #endregion

    #region Chart
    private ApexChart<SinglePoint> chart;

    ApexChartOptions<SinglePoint> options = new ApexCharts.ApexChartOptions<SinglePoint>()
        {
            Legend = new Legend()
            {

            },
            Theme = new Theme()
            {
                Mode = Mode.Dark
            }
        };

    private Dictionary<string, List<SinglePoint>> DataSeries { get; set; } = new Dictionary<string, List<SinglePoint>>()
    {
        {"Food", new List<SinglePoint>()},
        {"Clothes", new List<SinglePoint>()},
        {"Travels", new List<SinglePoint>()},
        {"Games", new List<SinglePoint>()},
        {"Subcriptions", new List<SinglePoint>()},
        {"Other", new List<SinglePoint>()}
    };

    public class SinglePoint
    {
        public DateTime Date { get; set; }
        public double Value { get; set; }

        public string CreateDateText()
        {
            return $"{Date.Month}/{Date.Year}";
        }
    }

    #endregion

    protected override void OnInitialized()
    {
        if (Feature == null) return;
        if (Feature is not Introduction receivedFeature) return;
        introduction = receivedFeature;

        userService.OnChange += HandleUserUpdate;

        // last 3 years
        int months = 36;
        for (int i = 0; i < months; i++)
        {
            foreach (var series in DataSeries)
            {
                series.Value.Add(new SinglePoint()
                    {
                        Date = DateTime.Now.AddMonths(-i),
                        Value = Random.Shared.Next(500) + Math.Round((double)Random.Shared.NextDouble(), 2)
                    });
            }
        }

        base.OnInitialized();
    }

    public void Dispose()
    {
        userService.OnChange -= HandleUserUpdate;
    }

    private void HandleUserUpdate()
    {
        if (userService.LoggedUser == null) return;

        options.Theme.Mode = userService.LoggedUser.UseDarkTheme ? Mode.Dark : Mode.Light;
        StateHasChanged();
        chart.UpdateOptionsAsync(false, false, false);
        chart.RenderAsync();
    }
}